<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Johnny Ting  | 生产环境内存泄露分析</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.53" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="https://johnnyting.github.io/dist/css/app.955516233bcafa4d2a1c13cea63c7b50.css" rel="stylesheet">
    

    

    
      
<link rel="shortcut icon" href="https://dingxu66.oss-cn-beijing.aliyuncs.com/img/509a4c2df41d1c43e56234.jpg" type="image/x-icon" />


    

    

    <meta property="og:title" content="生产环境内存泄露分析" />
<meta property="og:description" content="项目基础架构: Java&#43;gRPC&#43;Rails 因生产环境频繁出现宕机的情况，平均一周需要重启下服务器，这谁顶得住啊。。这个问题必须解决。在开始分析问题之前，我们先重启一次" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://johnnyting.github.io/posts/%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E5%88%86%E6%9E%90/" /><meta property="article:published_time" content="2019-11-27T16:59:43&#43;08:00"/>
<meta property="article:modified_time" content="2019-11-27T16:59:43&#43;08:00"/>

<meta itemprop="name" content="生产环境内存泄露分析">
<meta itemprop="description" content="项目基础架构: Java&#43;gRPC&#43;Rails 因生产环境频繁出现宕机的情况，平均一周需要重启下服务器，这谁顶得住啊。。这个问题必须解决。在开始分析问题之前，我们先重启一次">


<meta itemprop="datePublished" content="2019-11-27T16:59:43&#43;08:00" />
<meta itemprop="dateModified" content="2019-11-27T16:59:43&#43;08:00" />
<meta itemprop="wordCount" content="3659">



<meta itemprop="keywords" content="ruby,java," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="生产环境内存泄露分析"/>
<meta name="twitter:description" content="项目基础架构: Java&#43;gRPC&#43;Rails 因生产环境频繁出现宕机的情况，平均一周需要重启下服务器，这谁顶得住啊。。这个问题必须解决。在开始分析问题之前，我们先重启一次"/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-gray">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://johnnyting.github.io/" class="f3 fw2 hover-white no-underline white-90 dib">
      Johnny Ting
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="https://johnnyting.github.io/" title="Home page">
              Home
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="https://johnnyting.github.io/posts/" title="Articles page">
              Articles
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="https://johnnyting.github.io/tags/" title="Tags page">
              Tags
            </a>
          </li>
          
        </ul>
      
      


<a href="https://www.facebook.com/xu.ding.9235" target="_blank" class="link-transition facebook link dib z-999 pt3 pt0-l mr1" title="Facebook link" rel="noopener" aria-label="follow on Facebook——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


<a href="https://twitter.com/johnnyting7" target="_blank" class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel="noopener" aria-label="follow on Twitter——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


<a href="https://www.instagram.com/" target="_blank" class="link-transition instagram link dib z-999 pt3 pt0-l mr1" title="Instagram link" rel="noopener" aria-label="follow on Instagram——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M42.271,26.578v-0.006c0.502,0,1.005,0.01,1.508-0.002  c0.646-0.017,1.172-0.57,1.172-1.217c0-0.963,0-1.927,0-2.89c0-0.691-0.547-1.24-1.236-1.241c-0.961,0-1.922-0.001-2.883,0  c-0.688,0.001-1.236,0.552-1.236,1.243c-0.001,0.955-0.004,1.91,0.003,2.865c0.001,0.143,0.028,0.291,0.073,0.426  c0.173,0.508,0.639,0.82,1.209,0.823C41.344,26.579,41.808,26.578,42.271,26.578z M33,27.817c-3.384-0.002-6.135,2.721-6.182,6.089  c-0.049,3.46,2.72,6.201,6.04,6.272c3.454,0.074,6.248-2.686,6.321-6.043C39.254,30.675,36.462,27.815,33,27.817z M21.046,31.116  v0.082c0,4.515-0.001,9.03,0,13.545c0,0.649,0.562,1.208,1.212,1.208c7.16,0.001,14.319,0.001,21.479,0  c0.656,0,1.215-0.557,1.215-1.212c0.001-4.509,0-9.02,0-13.528v-0.094h-2.912c0.411,1.313,0.537,2.651,0.376,4.014  c-0.161,1.363-0.601,2.631-1.316,3.803s-1.644,2.145-2.779,2.918c-2.944,2.006-6.821,2.182-9.946,0.428  c-1.579-0.885-2.819-2.12-3.685-3.713c-1.289-2.373-1.495-4.865-0.739-7.451C22.983,31.116,22.021,31.116,21.046,31.116z   M45.205,49.255c0.159-0.026,0.318-0.049,0.475-0.083c1.246-0.265,2.264-1.304,2.508-2.557c0.025-0.137,0.045-0.273,0.067-0.409  V21.794c-0.021-0.133-0.04-0.268-0.065-0.401c-0.268-1.367-1.396-2.428-2.78-2.618c-0.058-0.007-0.113-0.02-0.17-0.03H20.761  c-0.147,0.027-0.296,0.047-0.441,0.08c-1.352,0.308-2.352,1.396-2.545,2.766c-0.008,0.057-0.02,0.114-0.029,0.171V46.24  c0.028,0.154,0.05,0.311,0.085,0.465c0.299,1.322,1.427,2.347,2.77,2.52c0.064,0.008,0.13,0.021,0.195,0.03H45.205z M33,64  C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


<a href="https://www.youtube.com" target="_blank" class="link-transition youtube link dib z-999 pt3 pt0-l mr1" title="Youtube link" rel="noopener" aria-label="follow on Youtube——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M42.527,41.34c-0.278,0-0.478,0.078-0.6,0.244  c-0.121,0.156-0.18,0.424-0.18,0.796v0.896h1.543V42.38c0-0.372-0.062-0.64-0.185-0.796C42.989,41.418,42.792,41.34,42.527,41.34z   M36.509,41.309c0.234,0,0.417,0.076,0.544,0.23c0.123,0.155,0.185,0.383,0.185,0.682v4.584c0,0.286-0.053,0.487-0.153,0.611  c-0.1,0.127-0.256,0.189-0.47,0.189c-0.148,0-0.287-0.033-0.421-0.096c-0.135-0.062-0.274-0.171-0.415-0.313v-5.531  c0.119-0.122,0.239-0.213,0.36-0.271C36.26,41.335,36.383,41.309,36.509,41.309z M41.748,44.658v1.672  c0,0.468,0.057,0.792,0.17,0.974c0.118,0.181,0.313,0.269,0.592,0.269c0.289,0,0.491-0.076,0.606-0.229  c0.114-0.153,0.175-0.489,0.175-1.013v-0.405h1.795v0.456c0,0.911-0.217,1.596-0.657,2.059c-0.435,0.459-1.089,0.687-1.958,0.687  c-0.781,0-1.398-0.242-1.847-0.731c-0.448-0.486-0.676-1.157-0.676-2.014v-3.986c0-0.768,0.249-1.398,0.742-1.882  c0.493-0.484,1.128-0.727,1.911-0.727c0.799,0,1.413,0.225,1.843,0.674c0.429,0.448,0.642,1.093,0.642,1.935v2.264H41.748z   M38.623,48.495c-0.271,0.336-0.669,0.501-1.187,0.501c-0.343,0-0.646-0.062-0.912-0.192c-0.267-0.129-0.519-0.327-0.746-0.601  v0.681h-1.764V36.852h1.764v3.875c0.237-0.27,0.485-0.478,0.748-0.616c0.267-0.143,0.534-0.212,0.805-0.212  c0.554,0,0.975,0.189,1.265,0.565c0.294,0.379,0.438,0.933,0.438,1.66v4.926C39.034,47.678,38.897,48.159,38.623,48.495z   M30.958,48.884v-0.976c-0.325,0.361-0.658,0.636-1.009,0.822c-0.349,0.191-0.686,0.282-1.014,0.282  c-0.405,0-0.705-0.129-0.913-0.396c-0.201-0.266-0.305-0.658-0.305-1.189v-7.422h1.744v6.809c0,0.211,0.037,0.362,0.107,0.457  c0.077,0.095,0.196,0.141,0.358,0.141c0.128,0,0.292-0.062,0.488-0.188c0.197-0.125,0.375-0.283,0.542-0.475v-6.744h1.744v8.878  H30.958z M24.916,38.6v10.284h-1.968V38.6h-2.034v-1.748h6.036V38.6H24.916z M32.994,32.978c0-0.001,12.08,0.018,13.514,1.45  c1.439,1.435,1.455,8.514,1.455,8.555c0,0-0.012,7.117-1.455,8.556C45.074,52.969,32.994,53,32.994,53s-12.079-0.031-13.516-1.462  c-1.438-1.435-1.441-8.502-1.441-8.556c0-0.041,0.004-7.12,1.441-8.555C20.916,32.996,32.994,32.977,32.994,32.978z M42.52,29.255  h-1.966v-1.08c-0.358,0.397-0.736,0.703-1.13,0.909c-0.392,0.208-0.771,0.312-1.14,0.312c-0.458,0-0.797-0.146-1.027-0.437  c-0.229-0.291-0.345-0.727-0.345-1.311v-8.172h1.962v7.497c0,0.231,0.045,0.399,0.127,0.502c0.08,0.104,0.216,0.156,0.399,0.156  c0.143,0,0.327-0.069,0.548-0.206c0.22-0.137,0.423-0.312,0.605-0.527v-7.422h1.966V29.255z M31.847,27.588  c0.139,0.147,0.339,0.219,0.6,0.219c0.266,0,0.476-0.075,0.634-0.223c0.157-0.152,0.235-0.358,0.235-0.618v-5.327  c0-0.214-0.08-0.387-0.241-0.519c-0.16-0.131-0.37-0.196-0.628-0.196c-0.241,0-0.435,0.065-0.586,0.196  c-0.148,0.132-0.225,0.305-0.225,0.519v5.327C31.636,27.233,31.708,27.439,31.847,27.588z M30.408,19.903  c0.528-0.449,1.241-0.674,2.132-0.674c0.812,0,1.48,0.237,2.001,0.711c0.517,0.473,0.777,1.083,0.777,1.828v5.051  c0,0.836-0.255,1.491-0.762,1.968c-0.513,0.476-1.212,0.714-2.106,0.714c-0.858,0-1.547-0.246-2.064-0.736  c-0.513-0.492-0.772-1.152-0.772-1.983v-5.068C29.613,20.954,29.877,20.351,30.408,19.903z M24.262,16h-2.229l2.634,8.003v5.252  h2.213v-5.5L29.454,16h-2.25l-1.366,5.298h-0.139L24.262,16z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30  S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>



<a href="https://github.com/JohnnyTing" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel="noopener" aria-label="follow on Github——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>



    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        POSTS
      </p>
      <h1 class="f1 athelas mb1">生产环境内存泄露分析</h1>
      
      <time class="f6 mv4 dib tracked" datetime="2019-11-27T16:59:43&#43;08:00">November 27, 2019</time>      
      
      
    </header>

    <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>项目基础架构:  Java+gRPC+Rails</p>

<p>因生产环境频繁出现宕机的情况，平均一周需要重启下服务器，这谁顶得住啊。。这个问题必须解决。在开始分析问题之前，我们先重启一次服务器，然后每天记录cpu、内存使用情况。内存记录如下：</p>

<pre><code class="language-textile">重启后第一次内存展示：
➜  ~ free -h
        total        used        free      shared  buff/cache   available
Mem:     7.8G        4.3G        2.7G         14M        837M        3.2G
Swap:      0B          0B          0B


第二天：
➜  ~ free -h
         total       used        free      shared  buff/cache   available
Mem:     7.8G        5.2G        1.1G         14M        1.5G        2.3G
Swap:      0B          0B          0B


第三天:
➜  ~ free -h
         total      used        free      shared  buff/cache   available
Mem:     7.8G        5.6G        691M         14M      1.6G        1.9G
Swap:      0B          0B          0B


第四天：
➜  ~ free -h
         total       used        free      shared  buff/cache   available
Mem:     7.8G        5.8G        330M         14M        1.7G        1.7G
Swap:     0B          0B          0B


第五天:
➜  ~ free -h
         total       used        free      shared  buff/cache   available
Mem:     7.8G        6.4G        181M         14M        1.2G        1.0G
Swap:      0B          0B          0B


第六天：
➜  ~ free -h
        total       used        free      shared  buff/cache   available
Mem:     7.8G       6.8G        211M         14M        819M        704M
Swap:      0B         0B          0B
</code></pre>

<p>从上面可以看到内存占用每天递增，并不会释放，基本可以断定是内存泄露了，当内存消耗光服务器就卡死了。接下来我们就开始具体分析哪里出了问题，通过top命令查看进程内存占用情况：</p>

<pre><code class="language-textile">➜  ~ top （然后按M,按照内存占用倒序排序展示）
 PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
 1492 uugm      20   0 5784920 1.767g   9444 S   0.0 22.7  28:10.18 java
28426 root      20   0 3069812 1.201g  24992 S   0.0 15.4   9:24.44 ruby
 2501 uugm      20   0 5781664 1.083g   9564 S   0.0 13.9  12:35.30 java
 2672 uugm      20   0 5064376 857924   9216 S   0.0 10.5   4:11.96 java
 2628 uugm      20   0 1177596 321708   9728 S   0.0  3.9   1:15.28 node
 1771 uugm      20   0 4452920 255852   9180 S   0.0  3.1   3:48.27 java
</code></pre>

<p>其实通过内存占用记录(这里top的数据记录就没有粘贴了)，可以判断有两个java进程(1492、2501)内存一直递增，一个ruby进程(28426)一直递增。经过查看这两个java进程都使用到了grpc，其他没有使用grpc的java进程内存没有递增，很有可能是grpc的问题，当然现在只是我的猜测，我们需要进一步分析。</p>

<p>1.将pid为1492的java进程的整个heap堆数据dump出来，文件形式为二进制文件</p>

<pre><code class="language-textile">jmap -dump:format=b,file=heap.bin 1492

# 会生成heap.bin文件，可能会比较大,这里是1.3g
-rw------- 1 user group 1.3G Nov 25 20:52 heap.bin
</code></pre>

<p>2.下载二进制文件到本地</p>

<pre><code class="language-shell">scp user@xxx.xxx.com:/home/user/heap.bin ../mat/
</code></pre>

<p>3.下载Memory Analyzer (MAT)内存分析软件。<a href="https://www.eclipse.org/mat/">MAT下载</a></p>

<p>4.然后通过MAT打开heap.bin文件</p>

<p><img src="https://dingxu66.oss-cn-beijing.aliyuncs.com/img/Yinxiang_2019112717:26:42.png" alt="" /></p>

<p>可以看到有两个可疑问题</p>

<p><img src="https://dingxu66.oss-cn-beijing.aliyuncs.com/img/Yinxiang_2019112717:28:03.png" alt="" /></p>

<p><img src="https://dingxu66.oss-cn-beijing.aliyuncs.com/img/Yinxiang_2019112717:28:06.png" alt="" /></p>

<p>正如我们的猜想一样，确实和grpc有关，并且是grpc中依赖的netty库有关。由上图可知netty中的worker的WeakHashMap数组中存在大量对象没有被回收，从而导致内存一直增加。</p>

<p>5.经过一番google，然后找到了是netty版本的问题，我们项目中grpc版本是1.0.0，其中它依赖的netty版本是4.1.3.Final，此版本存在内存泄露。具体可以看<a href="https://github.com/grpc/grpc-java/issues/2358">https://github.com/grpc/grpc-java/issues/2358</a>。</p>

<p><img src="https://dingxu66.oss-cn-beijing.aliyuncs.com/img/Yinxiang_2019112717:30:25.png" alt="" /></p>

<p>上面提到说可以指定固定的线程池来解决它，也可以更新netty版本。</p>

<pre><code class="language-textile">but the issue is fixed in Netty 4.1.6.Final.
</code></pre>

<p>在Netty 4.1.6.Final版本修复了这个bug，我们就更新grpc版本来解决它。grpc版本应该小幅度提升并保证能解决此bug，以免项目中使用的一些方法被新版本废弃不能使用。我们就提升grpc到1.0.3，此版本netty为4.1.6.Final</p>

<p><img src="https://dingxu66.oss-cn-beijing.aliyuncs.com/img/Yinxiang_2019112717:32:21.png" alt="" /></p>

<p>好了，目前java进程的内存泄露分析到此为止，我们还有个ruby进程，内存也是持续增加，接下来继续分析。</p>

<p>6.难道ruby进程也存在内存泄露？</p>

<p>我网上搜了一些ruby内存泄露的帖子，<a href="https://ruby-china.org/topics/27057">https://ruby-china.org/topics/27057</a>， <a href="https://ruby-china.org/topics/35238">https://ruby-china.org/topics/35238</a></p>

<p>他们的结论差不多都是：</p>

<pre><code class="language-textile">* 减少全局对象（在Ruby中一个对象一旦被全局对象引用，它就不会被垃圾回收）
* 减少创建大的对象
* 减少创建的对象
* 数据库查询尽量使用limit限制查询结果条数
* 避免n+1查询
</code></pre>

<p>其实我们Rails项目中确实用到了一些全局对象并且是大对象，会不会是这个问题？但这些都是必须的，很多接口都要用到这些大对象，如果不用全局变量，那么每次请求都要新创建一个大对象，内存占用一样的大，了解了下ruby的gc机制，这些大对象用了之后可能还不会完全释放，内存占用也许会更大。</p>

<p>这就僵住了呀，那该怎么解决呢？</p>

<p>我无奈之下重启了下puma，看看有什么不同。</p>

<pre><code class="language-shell">touch tmp/restart.txt
</code></pre>

<p>我惊奇的发现服务器内存瞬间释放了2G</p>

<pre><code class="language-textile">➜ ~ free -h
     total  used  free  shared  buff/cache  available
Mem:  7.8G  4.8G  1.9G   14M     1.1G        2.6G
Swap:  0B    0B   0B
</code></pre>

<p>难道是puma的问题？</p>

<p>我又开始了搜索，哈哈。找到puma内存占用相关的帖子，<a href="https://ruby-china.org/topics/35236">https://ruby-china.org/topics/35236</a></p>

<p>引用别人的结论：</p>

<pre><code class="language-textile">puma 和 unicorn 都不会主动降低操作系统内存占用, 但会复用已经申请过的内存.
所以会随着每分钟请求量的增加导致内存不断上升. 如果超出某个极限, 则有可能导致
内存爆掉. 可以考虑使用puma_worker_killer进行控制.
</code></pre>

<p>似乎又有点思路了，就算没有真正解决内存泄露的问题，也可以用puma_worker_killer来控制内存占用来解决服务器宕机的问题。</p>

<p>puma_worker_killer github地址: <a href="https://github.com/schneems/puma_worker_killer">https://github.com/schneems/puma_worker_killer</a></p>

<p>7.按照puma_worker_killer文档，稍作修改puma.rb</p>

<pre><code class="language-ruby">before_fork do
 PumaWorkerKiller.config do |config|
 config.ram = 1024*2 # mb
 config.frequency = 20 # seconds
 config.percent_usage = 0.98
 config.rolling_restart_frequency = false
 config.pre_term = -&gt; (worker) { File.open(&quot;#{Rails.root}/log/workers-killed.log&quot;, 'w') { |file| file.write(&quot;Worker #{worker.inspect} being killed&quot;) } }
 end
 PumaWorkerKiller.start
end
threads_count = ENV.fetch(&quot;RAILS_MAX_THREADS&quot;) { 5 }
threads 0, threads_count
bind 'unix:/tmp/puma.uugm-tz.sock'
environment ENV.fetch(&quot;RAILS_ENV&quot;) { &quot;production&quot; }
daemonize true
workers ENV.fetch(&quot;WEB_CONCURRENCY&quot;) { 2 }
preload_app!
plugin :tmp_restart
</code></pre>

<p>8.经过上面更改之后的内存记录</p>

<p>第一天:</p>

<pre><code>➜  ~ free -h
      total        used        free      shared  buff/cache   available
Mem:   7.8G        5.2G        806M         14M        1.8G        2.3G
Swap:   0B          0B          0B

➜  ~ top
PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
3577 uugm     20   0 5750012 1.217g  19884 S   0.0 15.6   5:07.58 java (rpc)
7354 root     20   0 2716908 984140  11928 S   0.0 12.0   3:36.96 ruby (puma: worker 0)
2672 uugm     20   0 5064376 857924   9216 S   0.0 10.5   4:59.27 java (ext-jcb)
2532 uugm     20   0 5778256 691360  22564 S   0.0  8.5   2:23.33 java (play-rpc)
8558 root     20   0 2318568 591512  11860 S   0.0  7.2   0:57.80 ruby (puma: worker 1)
4015 uugm     20   0 4452948 379472  19300 S   0.0  4.6   0:49.91 java
2628 uugm     20   0 1181244 329372  13344 S   0.0  4.0   1:28.98 node
3705 root     20   0 1109064 131188   4808 S   0.0  1.6   0:08.20 ruby 

</code></pre>

<p>第二天:</p>

<pre><code>➜  ~ free -h
      total        used        free      shared  buff/cache   available
Mem:   7.8G        5.0G        1.0G         14M        1.8G        2.5G
Swap:   0B          0B          0B

➜  ~ top
PID USER     PR  NI    VIRT    RES   SHR S %CPU   %MEM     TIME+ COMMAND
3577 uugm    20   0 5755144 1.269g  19884 S   0.0 16.3   7:27.48 java (rpc)
2672 uugm    20   0 5064376 857924   9216 S   0.3 10.5   5:14.08 java (ext-jcb)
8558 root    20   0 2453736 733712  11896 S   0.0  9.0   3:17.42 ruby (puma: worker 1)
2532 uugm    20   0 5780304 672312  22564 S   0.0  8.2   3:25.27 java (play-rpc)
12938 root   20   0 2321756 576872  11844 S   0.3  7.1   0:34.98 ruby (puma: worker 0)
4015 uugm    20   0 4452948 358768  19300 S   0.3  4.4   1:06.05 java
2628 uugm    20   0 1183744 333516  13344 S   0.0  4.1   1:31.31 node
3705 root    20   0 1109064 131216   4808 S   0.0  1.6   0:12.56 ruby
 
这里可以发现puma worker-0 进程的pid由7354变为12938，是因为当此worker内存占用过高时，puma_worker_killer将其重启了，从worker kill日志信息也可以看到。（之后worker pid发生变化都是这个原因，不在赘述了）
</code></pre>

<pre><code>第三天：

➜  ~ free -h
      total        used        free      shared  buff/cache   available
Mem:   7.8G        5.6G        763M         14M        1.4G        1.9G
Swap:   0B          0B          0B

第四天:

➜  ~ free -h
      total        used        free      shared  buff/cache   available
Mem:   7.8G        5.4G       965M         14M        1.5G        2.1G
Swap:   0B          0B          0B

第五天：
➜  ~ free -h
      total        used        free      shared  buff/cache   available
Mem:   7.8G        5.1G        1.0G         14M        1.6G        2.4G
Swap:   0B          0B          0B

第六天：
➜  ~ free -h
      total        used        free      shared  buff/cache   available
Mem:   7.8G        5.5G        1.0G         14M        1.2G        1.9G
Swap:   0B          0B          0B

第七天：
➜  ~ free -h
      total        used        free      shared  buff/cache   available
Mem:   7.8G        6.1G        134M         14M        1.5G        1.3G
Swap:   0B          0B          0B
</code></pre>

<p>经过一周的观察，并没有发现服务器宕机，是好事。但是我们看到rpc进程内存还是在递增，ruby的内存占用经过puma_worker_killer算是得到了缓解。那我们重新看下java进程的内存占用问题。</p>

<p>9.重新dump一份堆二进制文件，打开MAT软件。</p>

<p><img src="https://dingxu66.oss-cn-beijing.aliyuncs.com/img/Yinxiang_2019122616:24:46.png" alt="" /></p>

<p><img src="https://dingxu66.oss-cn-beijing.aliyuncs.com/img/Yinxiang_2019122616:24:52.png" alt="" /></p>

<p><img src="https://dingxu66.oss-cn-beijing.aliyuncs.com/img/Yinxiang_2019122616:24:57.png" alt="" /></p>

<p><img src="https://dingxu66.oss-cn-beijing.aliyuncs.com/img/Yinxiang_2019122616:25:00.png" alt="" /></p>

<p>可以看到跟之前的可疑问题不一样了，java.lang.ref.Finalizer和org.postgresql.jdbc.PgConnection这两个类的对象占用率比较高。结合上面的可疑点3、可疑点4，很有可能是数据库连接未关闭的问题。</p>

<p>打开数据库连接对象的具体信息：</p>

<p><img src="https://dingxu66.oss-cn-beijing.aliyuncs.com/img/Yinxiang_2019122616:27:54.png" alt="" /></p>

<p><img src="https://dingxu66.oss-cn-beijing.aliyuncs.com/img/Yinxiang_2019122616:27:59.png" alt="" /></p>

<p>上图可以看到我们项目com.ut.uugm.core.assessment.AssessmentBusiness类可能存在问题。我们就具体看下代码：</p>

<pre><code class="language-java">private static final SqlSessionFactory SESSION = MybatisConfigure.sqlSessionFactory();
    public Optional&lt;InternalBusiness&gt; getInternalBusinessScore(long assessmentId, String packageName) {
        try (SqlSession sqlSession = SESSION.openSession(true)) {
           do something
        }
    }
</code></pre>

<p>在AssessmentBusiness类中可以看到很多用try-with-resources方式来自动关闭资源，首先我们需要了解为啥这种方式能自动关闭资源，是因为资源类实现了java.lang.AutoCloseable接口，那么mybatis的org.apache.ibatis.session.SqlSession接口是否继承了此接口呢</p>

<pre><code class="language-java">public interface SqlSession extends Closeable {
    &lt;T&gt; T selectOne(String var1);
    &lt;T&gt; T selectOne(String var1, Object var2);
    something...
}

public interface Closeable extends AutoCloseable {
    public void close() throws IOException;
}
</code></pre>

<p>可见SqlSession继承了此接口。通过测试，在try语句块后不能再次调用sqlSession，资源应该是被关闭了的。</p>

<p>既然问题定位到这里了，还是要看看代码的其他地方，我们看到这里定义了个静态常量：</p>

<pre><code class="language-java">private static final SqlSessionFactory SESSION = MybatisConfigure.sqlSessionFactory()
</code></pre>

<p>我们知道静态常量存在方法区（在Hotspot中，jdk1.8以下被称为永久代，jdk1.8以上被称为元空间），此区域存放类的基本信息，GC频率很低。如果常量没有被引用则可以被回收，因为很多业务类都使用此方式创建SqlSessionFactory，并且MybatisConfigure.sqlSessionFactory()也创建的是一个单例对象，所以多个类的SESSION应该指向是同一个SqlSessionFactory，通过MAT看SESSION哈希地址相同也可以验证。那么多个类都持有此SESSION，此常量不被回收。你可能会问：Mybatis的SqlSessionFactory不是一个应用程序就该产生一个吗，然后由它创建SqlSession，此SESSION符合要求。但是需要注意的是，这里不是SqlSessionFactory产生一个实例的问题，而是常量没被回收导致其引用的数据库连接类也没被释放的问题。</p>

<p>这里我们稍微改下代码，去掉静态常量，使用下面方式获取session：</p>

<pre><code class="language-java">try (SqlSession sqlSession = MybatisConfigure.sqlSessionFactory().openSession(true)) {
    do something...
}
</code></pre>

<p>修改获取session代码后的内存记录：</p>

<pre><code>
</code></pre>
<ul class="pa0">
  
   <li class="list">
     <a href="https://johnnyting.github.io/tags/ruby" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">ruby</a>
   </li>
  
   <li class="list">
     <a href="https://johnnyting.github.io/tags/java" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">java</a>
   </li>
  
</ul>
<div class="mt6">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "JohnnyTing" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    </section>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="https://johnnyting.github.io/posts/sidekiq%E5%90%8E%E5%8F%B0%E4%BB%BB%E5%8A%A1%E7%9A%84%E7%AE%80%E5%8D%95%E9%85%8D%E7%BD%AE/">Sidekiq后台任务的简单配置</a>
        </li>
	    
	     <li  class="mb2">
          <a href="https://johnnyting.github.io/posts/%E4%BF%AE%E6%94%B9puma%E6%BA%90%E7%A0%81%E4%B8%ADget%E8%AF%B7%E6%B1%82%E5%9C%B0%E5%9D%80%E9%95%BF%E5%BA%A6%E7%9A%84%E6%9C%80%E5%A4%A7%E5%80%BC/">修改puma源码中GET请求地址长度的最大值</a>
        </li>
	    
	     <li  class="mb2">
          <a href="https://johnnyting.github.io/posts/%E4%BD%BF%E7%94%A8vscode%E5%A6%82%E4%BD%95%E6%9D%A5debug-rails%E5%BA%94%E7%94%A8/">使用vscode如何来debug Rails应用</a>
        </li>
	    
	     <li  class="mb2">
          <a href="https://johnnyting.github.io/posts/rails%E8%87%AA%E5%AE%9A%E4%B9%89%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E4%BD%8D%E7%BD%AE/">Rails自定义日志文件存储位置</a>
        </li>
	    
	     <li  class="mb2">
          <a href="https://johnnyting.github.io/posts/rails%E4%BB%8E%E5%AF%B9%E8%B1%A1%E6%88%96%E8%80%85hash%E4%B8%AD%E8%8E%B7%E5%8F%96%E5%8E%BB%E9%99%A4%E6%9F%90%E4%BA%9B%E5%B1%9E%E6%80%A7/">Rails从对象或者hash中获取、去除某些属性</a>
        </li>
	    
	     <li  class="mb2">
          <a href="https://johnnyting.github.io/posts/rails%E4%B8%ADtry%E7%9A%84%E7%94%A8%E6%B3%95/">Rails中try的用法</a>
        </li>
	    
	     <li  class="mb2">
          <a href="https://johnnyting.github.io/posts/ruby%E4%B8%AD%E7%A5%9E%E5%A5%87%E7%9A%84%E7%AC%A6%E5%8F%B7/">Ruby中神奇的&amp;符号</a>
        </li>
	    
	     <li  class="mb2">
          <a href="https://johnnyting.github.io/posts/ruby%E4%B8%AD%E7%AC%A6%E5%8F%B7%E7%90%86%E8%A7%A3/">Ruby中||=符号理解</a>
        </li>
	    
	     <li  class="mb2">
          <a href="https://johnnyting.github.io/posts/ruby%E4%B8%AD%E5%86%92%E5%8F%B7%E4%BB%A3%E8%A1%A8%E7%9A%84%E6%84%8F%E6%80%9D/">Ruby中冒号代表的意思</a>
        </li>
	    
	     <li  class="mb2">
          <a href="https://johnnyting.github.io/posts/rails%E4%B8%AD%E5%BB%BA%E7%AB%8Bar%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%85%B3%E8%81%94%E5%85%B3%E7%B3%BB/">Rails中建立AR模型的关联关系</a>
        </li>
	    
	     <li  class="mb2">
          <a href="https://johnnyting.github.io/posts/rails%E9%9B%86%E6%88%90axlsx%E5%AE%9E%E7%8E%B0%E5%AF%BC%E5%87%BAexcel%E5%8A%9F%E8%83%BD/">Rails集成axlsx实现导出excel功能</a>
        </li>
	    
	     <li  class="mb2">
          <a href="https://johnnyting.github.io/posts/ruby%E4%B8%AD%E7%9A%84%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA/">第十五章、ruby中的输入输出</a>
        </li>
	    
	     <li  class="mb2">
          <a href="https://johnnyting.github.io/posts/ruby%E4%B8%AD%E7%9A%84%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/">第十四章、ruby中的正则表达式</a>
        </li>
	    
	     <li  class="mb2">
          <a href="https://johnnyting.github.io/posts/ruby%E4%B8%AD%E7%9A%84%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B2/">第十三章、ruby中的面向对象编程2</a>
        </li>
	    
	     <li  class="mb2">
          <a href="https://johnnyting.github.io/posts/ruby%E4%B8%AD%E7%9A%84%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B/">第十二章、ruby中的面向对象编程</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-gray bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://johnnyting.github.io/" >
    &copy; 2019 Johnny Ting
  </a>
    <div>


<a href="https://www.facebook.com/xu.ding.9235" target="_blank" class="link-transition facebook link dib z-999 pt3 pt0-l mr1" title="Facebook link" rel="noopener" aria-label="follow on Facebook——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


<a href="https://twitter.com/johnnyting7" target="_blank" class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel="noopener" aria-label="follow on Twitter——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


<a href="https://www.instagram.com/" target="_blank" class="link-transition instagram link dib z-999 pt3 pt0-l mr1" title="Instagram link" rel="noopener" aria-label="follow on Instagram——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M42.271,26.578v-0.006c0.502,0,1.005,0.01,1.508-0.002  c0.646-0.017,1.172-0.57,1.172-1.217c0-0.963,0-1.927,0-2.89c0-0.691-0.547-1.24-1.236-1.241c-0.961,0-1.922-0.001-2.883,0  c-0.688,0.001-1.236,0.552-1.236,1.243c-0.001,0.955-0.004,1.91,0.003,2.865c0.001,0.143,0.028,0.291,0.073,0.426  c0.173,0.508,0.639,0.82,1.209,0.823C41.344,26.579,41.808,26.578,42.271,26.578z M33,27.817c-3.384-0.002-6.135,2.721-6.182,6.089  c-0.049,3.46,2.72,6.201,6.04,6.272c3.454,0.074,6.248-2.686,6.321-6.043C39.254,30.675,36.462,27.815,33,27.817z M21.046,31.116  v0.082c0,4.515-0.001,9.03,0,13.545c0,0.649,0.562,1.208,1.212,1.208c7.16,0.001,14.319,0.001,21.479,0  c0.656,0,1.215-0.557,1.215-1.212c0.001-4.509,0-9.02,0-13.528v-0.094h-2.912c0.411,1.313,0.537,2.651,0.376,4.014  c-0.161,1.363-0.601,2.631-1.316,3.803s-1.644,2.145-2.779,2.918c-2.944,2.006-6.821,2.182-9.946,0.428  c-1.579-0.885-2.819-2.12-3.685-3.713c-1.289-2.373-1.495-4.865-0.739-7.451C22.983,31.116,22.021,31.116,21.046,31.116z   M45.205,49.255c0.159-0.026,0.318-0.049,0.475-0.083c1.246-0.265,2.264-1.304,2.508-2.557c0.025-0.137,0.045-0.273,0.067-0.409  V21.794c-0.021-0.133-0.04-0.268-0.065-0.401c-0.268-1.367-1.396-2.428-2.78-2.618c-0.058-0.007-0.113-0.02-0.17-0.03H20.761  c-0.147,0.027-0.296,0.047-0.441,0.08c-1.352,0.308-2.352,1.396-2.545,2.766c-0.008,0.057-0.02,0.114-0.029,0.171V46.24  c0.028,0.154,0.05,0.311,0.085,0.465c0.299,1.322,1.427,2.347,2.77,2.52c0.064,0.008,0.13,0.021,0.195,0.03H45.205z M33,64  C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


<a href="https://www.youtube.com" target="_blank" class="link-transition youtube link dib z-999 pt3 pt0-l mr1" title="Youtube link" rel="noopener" aria-label="follow on Youtube——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M42.527,41.34c-0.278,0-0.478,0.078-0.6,0.244  c-0.121,0.156-0.18,0.424-0.18,0.796v0.896h1.543V42.38c0-0.372-0.062-0.64-0.185-0.796C42.989,41.418,42.792,41.34,42.527,41.34z   M36.509,41.309c0.234,0,0.417,0.076,0.544,0.23c0.123,0.155,0.185,0.383,0.185,0.682v4.584c0,0.286-0.053,0.487-0.153,0.611  c-0.1,0.127-0.256,0.189-0.47,0.189c-0.148,0-0.287-0.033-0.421-0.096c-0.135-0.062-0.274-0.171-0.415-0.313v-5.531  c0.119-0.122,0.239-0.213,0.36-0.271C36.26,41.335,36.383,41.309,36.509,41.309z M41.748,44.658v1.672  c0,0.468,0.057,0.792,0.17,0.974c0.118,0.181,0.313,0.269,0.592,0.269c0.289,0,0.491-0.076,0.606-0.229  c0.114-0.153,0.175-0.489,0.175-1.013v-0.405h1.795v0.456c0,0.911-0.217,1.596-0.657,2.059c-0.435,0.459-1.089,0.687-1.958,0.687  c-0.781,0-1.398-0.242-1.847-0.731c-0.448-0.486-0.676-1.157-0.676-2.014v-3.986c0-0.768,0.249-1.398,0.742-1.882  c0.493-0.484,1.128-0.727,1.911-0.727c0.799,0,1.413,0.225,1.843,0.674c0.429,0.448,0.642,1.093,0.642,1.935v2.264H41.748z   M38.623,48.495c-0.271,0.336-0.669,0.501-1.187,0.501c-0.343,0-0.646-0.062-0.912-0.192c-0.267-0.129-0.519-0.327-0.746-0.601  v0.681h-1.764V36.852h1.764v3.875c0.237-0.27,0.485-0.478,0.748-0.616c0.267-0.143,0.534-0.212,0.805-0.212  c0.554,0,0.975,0.189,1.265,0.565c0.294,0.379,0.438,0.933,0.438,1.66v4.926C39.034,47.678,38.897,48.159,38.623,48.495z   M30.958,48.884v-0.976c-0.325,0.361-0.658,0.636-1.009,0.822c-0.349,0.191-0.686,0.282-1.014,0.282  c-0.405,0-0.705-0.129-0.913-0.396c-0.201-0.266-0.305-0.658-0.305-1.189v-7.422h1.744v6.809c0,0.211,0.037,0.362,0.107,0.457  c0.077,0.095,0.196,0.141,0.358,0.141c0.128,0,0.292-0.062,0.488-0.188c0.197-0.125,0.375-0.283,0.542-0.475v-6.744h1.744v8.878  H30.958z M24.916,38.6v10.284h-1.968V38.6h-2.034v-1.748h6.036V38.6H24.916z M32.994,32.978c0-0.001,12.08,0.018,13.514,1.45  c1.439,1.435,1.455,8.514,1.455,8.555c0,0-0.012,7.117-1.455,8.556C45.074,52.969,32.994,53,32.994,53s-12.079-0.031-13.516-1.462  c-1.438-1.435-1.441-8.502-1.441-8.556c0-0.041,0.004-7.12,1.441-8.555C20.916,32.996,32.994,32.977,32.994,32.978z M42.52,29.255  h-1.966v-1.08c-0.358,0.397-0.736,0.703-1.13,0.909c-0.392,0.208-0.771,0.312-1.14,0.312c-0.458,0-0.797-0.146-1.027-0.437  c-0.229-0.291-0.345-0.727-0.345-1.311v-8.172h1.962v7.497c0,0.231,0.045,0.399,0.127,0.502c0.08,0.104,0.216,0.156,0.399,0.156  c0.143,0,0.327-0.069,0.548-0.206c0.22-0.137,0.423-0.312,0.605-0.527v-7.422h1.966V29.255z M31.847,27.588  c0.139,0.147,0.339,0.219,0.6,0.219c0.266,0,0.476-0.075,0.634-0.223c0.157-0.152,0.235-0.358,0.235-0.618v-5.327  c0-0.214-0.08-0.387-0.241-0.519c-0.16-0.131-0.37-0.196-0.628-0.196c-0.241,0-0.435,0.065-0.586,0.196  c-0.148,0.132-0.225,0.305-0.225,0.519v5.327C31.636,27.233,31.708,27.439,31.847,27.588z M30.408,19.903  c0.528-0.449,1.241-0.674,2.132-0.674c0.812,0,1.48,0.237,2.001,0.711c0.517,0.473,0.777,1.083,0.777,1.828v5.051  c0,0.836-0.255,1.491-0.762,1.968c-0.513,0.476-1.212,0.714-2.106,0.714c-0.858,0-1.547-0.246-2.064-0.736  c-0.513-0.492-0.772-1.152-0.772-1.983v-5.068C29.613,20.954,29.877,20.351,30.408,19.903z M24.262,16h-2.229l2.634,8.003v5.252  h2.213v-5.5L29.454,16h-2.25l-1.366,5.298h-0.139L24.262,16z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30  S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>



<a href="https://github.com/JohnnyTing" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel="noopener" aria-label="follow on Github——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


</div>
  </div>
</footer>

    

  <script src="https://johnnyting.github.io/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
